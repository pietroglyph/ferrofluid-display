<!doctype html><html class=no-js lang=en-us>
<head>
<meta charset=utf-8>
<title>Systems</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="An overview of our ferrofluid project's journey">
<meta name=author content="Olin College Ferrofluid Team">
<meta name=generator content="Hugo 0.90.1">
<link rel=stylesheet href=https://pietroglyph.github.io/ferrofluid-display/css/wp-library.min.css media=screen>
<link rel=stylesheet href=https://pietroglyph.github.io/ferrofluid-display/css/style.min.css media=screen>
<link rel=stylesheet href=https://pietroglyph.github.io/ferrofluid-display/css/custom-style.min.css media=screen>
<link rel="shortcut icon" href=https://pietroglyph.github.io/ferrofluid-display/images/favicon.png type=image/x-icon>
<link rel=icon href=https://pietroglyph.github.io/ferrofluid-display/images/favicon.png type=image/x-icon>
<script>document.documentElement.className=document.documentElement.className.replace('no-js','js')</script>
<script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}},window.addEventListener('load',a=>{document.querySelectorAll("mjx-container").forEach(function(a){a.parentElement.classList+='has-jax'})})</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script>
</head>
<body class="home page-template-default page wp-embed-responsive singular enable-search-modal has-post-thumbnail has-no-pagination not-showing-comments show-avatars footer-top-visible">
<header id=site-header class=header-footer-group role=banner>
<div class="header-inner section-inner">
<div class=header-titles-wrapper>
<button class="toggle search-toggle mobile-search-toggle" data-toggle-target=.search-modal data-toggle-body-class=showing-search-modal data-set-focus=".search-modal .search-field" aria-expanded=false>
<span class=toggle-inner>
<span class=toggle-icon><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewbox="0 0 23 23"><path d="M38.710696 48.0601792 43 52.3494831 41.3494831 54l-4.2893039-4.289304c-1.796937 1.4374225-4.0762685 2.2969539-6.5563543 2.2969539C24.7027226 52.0076499 20 47.3049272 20 41.5038249 20 35.7027226 24.7027226 31 30.5038249 31s10.503825 4.7027226 10.503825 10.5038249C41.0076499 43.9839107 40.1481185 46.2632422 38.710696 48.0601792zM36.3875844 47.1716785c1.4154377-1.4690138 2.2858822-3.4667821 2.2858822-5.6678536.0-4.5119684-3.6576732-8.1696416-8.1696417-8.1696416-4.5119684.0-8.1696416 3.6576732-8.1696416 8.1696416.0 4.5119685 3.6576732 8.1696417 8.1696416 8.1696417 2.2010715.0 4.1988398-.870444499999998 5.6678536-2.2858822C36.2023931 47.347638 36.2360451 47.3092237 36.2726343 47.2726343 36.3092237 47.2360451 36.347638 47.2023931 36.3875844 47.1716785z" transform="translate(-20 -31)"/></svg> </span>
<span class=toggle-text>Search</span>
</span>
</button>
<div class=header-titles>
<div class="site-title faux-heading"><a href=https://pietroglyph.github.io/ferrofluid-display/>Ferrofluid Display</a></div>
</div>
<button class="toggle nav-toggle mobile-nav-toggle" data-toggle-target=.menu-modal data-toggle-body-class=showing-menu-modal aria-expanded=false data-set-focus=.close-nav-toggle>
<span class=toggle-inner>
<span class=toggle-icon><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="26" height="7" viewbox="0 0 26 7"><path fill-rule="evenodd" d="M332.5 45c-1.932997.0-3.5-1.5670034-3.5-3.5s1.567003-3.5 3.5-3.5 3.5 1.5670034 3.5 3.5-1.567003 3.5-3.5 3.5zm9.5.0c-1.932997.0-3.5-1.5670034-3.5-3.5S340.067003 38 342 38s3.5 1.5670034 3.5 3.5S343.932997 45 342 45zm9.5.0c-1.932997.0-3.5-1.5670034-3.5-3.5s1.567003-3.5 3.5-3.5 3.5 1.5670034 3.5 3.5-1.567003 3.5-3.5 3.5z" transform="translate(-329 -38)"/></svg> </span>
<span class=toggle-text>Menu</span>
</span>
</button>
</div>
<div class=header-navigation-wrapper>
<nav class=primary-menu-wrapper aria-label=Horizontal role=navigation>
<ul class="primary-menu reset-list-style">
</ul>
</nav>
<div class="header-toggles hide-no-js">
<div class="toggle-wrapper nav-toggle-wrapper has-expanded-menu">
<button class="toggle nav-toggle desktop-nav-toggle" data-toggle-target=.menu-modal data-toggle-body-class=showing-menu-modal aria-expanded=false data-set-focus=.close-nav-toggle>
<span class=toggle-inner>
<span class=toggle-text>Menu</span>
<span class=toggle-icon><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="26" height="7" viewbox="0 0 26 7"><path fill-rule="evenodd" d="M332.5 45c-1.932997.0-3.5-1.5670034-3.5-3.5s1.567003-3.5 3.5-3.5 3.5 1.5670034 3.5 3.5-1.567003 3.5-3.5 3.5zm9.5.0c-1.932997.0-3.5-1.5670034-3.5-3.5S340.067003 38 342 38s3.5 1.5670034 3.5 3.5S343.932997 45 342 45zm9.5.0c-1.932997.0-3.5-1.5670034-3.5-3.5s1.567003-3.5 3.5-3.5 3.5 1.5670034 3.5 3.5-1.567003 3.5-3.5 3.5z" transform="translate(-329 -38)"/></svg> </span>
</span>
</button>
</div>
<div class="toggle-wrapper search-toggle-wrapper">
<button class="toggle search-toggle desktop-search-toggle" data-toggle-target=.search-modal data-toggle-body-class=showing-search-modal data-set-focus=".search-modal .search-field" aria-expanded=false>
<span class=toggle-inner><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewbox="0 0 23 23"><path d="M38.710696 48.0601792 43 52.3494831 41.3494831 54l-4.2893039-4.289304c-1.796937 1.4374225-4.0762685 2.2969539-6.5563543 2.2969539C24.7027226 52.0076499 20 47.3049272 20 41.5038249 20 35.7027226 24.7027226 31 30.5038249 31s10.503825 4.7027226 10.503825 10.5038249C41.0076499 43.9839107 40.1481185 46.2632422 38.710696 48.0601792zM36.3875844 47.1716785c1.4154377-1.4690138 2.2858822-3.4667821 2.2858822-5.6678536.0-4.5119684-3.6576732-8.1696416-8.1696417-8.1696416-4.5119684.0-8.1696416 3.6576732-8.1696416 8.1696416.0 4.5119685 3.6576732 8.1696417 8.1696416 8.1696417 2.2010715.0 4.1988398-.870444499999998 5.6678536-2.2858822C36.2023931 47.347638 36.2360451 47.3092237 36.2726343 47.2726343 36.3092237 47.2360451 36.347638 47.2023931 36.3875844 47.1716785z" transform="translate(-20 -31)"/></svg> <span class=toggle-text>Search</span>
</span>
</button>
</div>
</div>
</div>
</div>
<div class="search-modal cover-modal header-footer-group" data-modal-target-string=.search-modal>
<div class="search-modal-inner modal-inner">
<div class=section-inner>
<form role=search class=search-form action=/ferrofluid-display/search>
<label for=search-form-1>
<span class=screen-reader-text>Search for:</span>
<input id=search-query type=search class=search-field placeholder="Search &mldr;" name=s>
</label>
<input type=submit class=search-submit value=Search>
</form>
<button class="toggle search-untoggle close-search-toggle fill-children-current-color" data-toggle-target=.search-modal data-toggle-body-class=showing-search-modal data-set-focus=".search-modal .search-field" aria-expanded=false>
<span class=screen-reader-text>Close search</span><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 16 16"><polygon fill-rule="evenodd" points="6.852 7.649 .399 1.195 1.445 .149 7.899 6.602 14.352 .149 15.399 1.195 8.945 7.649 15.399 14.102 14.352 15.149 7.899 8.695 1.445 15.149 .399 14.102"/></svg> </button>
</div>
</div>
</div>
</header>
<div class="menu-modal cover-modal header-footer-group" data-modal-target-string=.menu-modal>
<div class="menu-modal-inner modal-inner">
<div class="menu-wrapper section-inner">
<div class=menu-top>
<button class="toggle close-nav-toggle fill-children-current-color" data-toggle-target=.menu-modal data-toggle-body-class=showing-menu-modal aria-expanded=false data-set-focus=.menu-modal>
<span class=toggle-text>Close Menu</span><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 16 16"><polygon fill-rule="evenodd" points="6.852 7.649 .399 1.195 1.445 .149 7.899 6.602 14.352 .149 15.399 1.195 8.945 7.649 15.399 14.102 14.352 15.149 7.899 8.695 1.445 15.149 .399 14.102"/></svg> </button>
<nav class=expanded-menu aria-label=Expanded role=navigation>
<ul class="modal-menu reset-list-style">
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://pietroglyph.github.io/ferrofluid-display/ aria-current=page>Home</a></div>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://pietroglyph.github.io/ferrofluid-display/journey aria-current=page>Our Journey</a></div>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://pietroglyph.github.io/ferrofluid-display/systems aria-current=page>Systems</a></div>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://pietroglyph.github.io/ferrofluid-display/about aria-current=page>About</a></div>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://github.com/pietroglyph/ferrofluid-display aria-current=page>GitHub</a></div>
</li>
</ul>
</nav>
<nav class=mobile-menu aria-label=Mobile role=navigation>
<ul class="modal-menu reset-list-style">
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://pietroglyph.github.io/ferrofluid-display/ aria-current=page>Home</a></div>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://pietroglyph.github.io/ferrofluid-display/journey aria-current=page>Our Journey</a></div>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://pietroglyph.github.io/ferrofluid-display/systems aria-current=page>Systems</a></div>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://pietroglyph.github.io/ferrofluid-display/about aria-current=page>About</a></div>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom">
<div class=ancestor-wrapper><a href=https://github.com/pietroglyph/ferrofluid-display aria-current=page>GitHub</a></div>
</li>
</ul>
</nav>
</div>
<div class=menu-bottom>
<nav aria-label="Expanded Social links" role=navigation>
<ul class="social-menu reset-list-style social-icons fill-children-current-color">
</ul>
</nav>
</div>
</div>
</div>
</div>
<main id=site-content role=main>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry category-art category-editing tag-block tag-editor tag-gutenberg tag-wordpress">
<header class="entry-header has-text-align-center">
<div class="entry-header-inner section-inner medium">
<div class=entry-categories>
<span class=screen-reader-text>Categories</span>
<div class=entry-categories-inner>
</div>
</div>
<h2 class="entry-title heading-size-1">Systems</h2>
<div class="post-meta-wrapper post-meta-single post-meta-single-top">
<ul class=post-meta>
<li class="post-author meta-wrapper">
<span class=meta-icon>
<span class=screen-reader-text>Post author</span><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path d="M18 19C18 19.5522847 17.5522847 20 17 20S16 19.5522847 16 19V17c0-1.6568542-1.3431458-3-3-3H5c-1.65685425.0-3 1.3431458-3 3v2C2 19.5522847 1.55228475 20 1 20 .44771525 20 0 19.5522847.0 19V17c0-2.7614237 2.23857625-5 5-5h8c2.7614237.0 5 2.2385763 5 5v2zM9 10C6.23857625 10 4 7.76142375 4 5 4 2.23857625 6.23857625.0 9 0c2.7614237.0 5 2.23857625 5 5 0 2.76142375-2.2385763 5-5 5zM9 8c1.6568542.0 3-1.34314575 3-3 0-1.65685425-1.3431458-3-3-3C7.34314575 2 6 3.34314575 6 5S7.34314575 8 9 8z"/></svg> </span>
<span class=meta-text>
By
<a href=/ferrofluid-display/author/ferrofluid-team>Ferrofluid Team</a>
</span>
</li>
<li class="post-date meta-wrapper">
<span class=meta-icon>
<span class=screen-reader-text>Post date</span><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path d="M4.60069444 4.09375H3.25c-.77665043.0-1.40625.62959957-1.40625 1.40625V7.26736111h14.3125V5.5C16.15625 4.72334957 15.5266504 4.09375 14.75 4.09375H13.3993056v.46180556c0 .46599025-.3777598.84375-.84375.84375-.4659903.0-.84375-.37775975-.84375-.84375V4.09375H6.28819444v.46180556c0 .46599025-.37775974.84375-.84375.84375-.46599025.0-.84375-.37775975-.84375-.84375V4.09375zm1.6875-1.6875H11.7118056V1c0-.465990258.3777597-.84375.84375-.84375.4659902.0.84375.377759742.84375.84375V2.40625H14.75c1.7086309.0 3.09375 1.38511906 3.09375 3.09375V15.875c0 1.7086309-1.3851191 3.09375-3.09375 3.09375H3.25c-1.70863094.0-3.09375-1.3851191-3.09375-3.09375V5.5c0-1.70863094 1.38511906-3.09375 3.09375-3.09375H4.60069444V1c0-.465990258.37775975-.84375.84375-.84375.46599026.0.84375.377759742.84375.84375V2.40625zM1.84375 8.95486111V15.875c0 .776650400000001.62959957 1.40625 1.40625 1.40625h11.5C15.5266504 17.28125 16.15625 16.6516504 16.15625 15.875V8.95486111H1.84375z"/></svg> </span>
<span class=meta-text>
December 13, 2021
</span>
</li>
<li class="post-comment-link meta-wrapper">
<span class=meta-icon><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="19" height="19" viewbox="0 0 19 19"><path d="M9.43016863 13.2235931c.156078679999998-.1288941.35217887-.1993996.55459986-.1993996H15.0564516C15.8581553 13.0241935 16.5080645 12.3742843 16.5080645 11.5725806V3.44354839c0-.80170367-.6499092-1.45161291-1.4516129-1.45161291H3.44354839c-.80170367.0-1.45161291.64990924-1.45161291 1.45161291V11.5725806c0 .801703699999999.64990924 1.4516129 1.45161291 1.4516129H5.76612903c.4810222.0.87096774.389945599999999.87096774.870967799999999v1.635029l2.79307186-2.3065972zM3.44354839 14.766129C1.67980032 14.766129.25 13.3363287.25 11.5725806V3.44354839C.25 1.67980032 1.67980032.25 3.44354839.25H15.0564516C16.8201997.25 18.25 1.67980032 18.25 3.44354839V11.5725806c0 1.7637481-1.4298003 3.1935484-3.1935484 3.1935484H10.2979143L6.32072889 18.0506004C5.75274472 18.5196577 4.89516129 18.1156602 4.89516129 17.3790323V14.766129H3.44354839z"/></svg> </span>
<span class=meta-text>
<a href=https://pietroglyph.github.io/ferrofluid-display/systems/#comments>Comments<span class=screen-reader-text> on
Systems</span></a> </span>
</li>
</ul>
</div>
</div>
</header>
<div class="post-inner thin">
<div class=entry-content>
<h5 id=contents-a-idnavigationa>Contents: <a id=Navigation></a></h5>
<ul>
<li><a href=#tank>Tank</a></li>
<li><a href=#magnets>Magnets</a></li>
<li><a href=#controller>Controller</a></li>
<li><a href=#firmware>Firmware</a></li>
<li><a href=#animation>Animation and Software</a></li>
<li><a href=#budget>Budget</a></li>
</ul>
<p><a id=system></a>
Our system is comprised of mechanical, electrical, firmware, and software subsystems (click on diagram to enlarge image):</p>
<p><a href=../images/system_diagram.jpg><img src=../images/system_diagram.jpg alt=system_diagram></a></p>
<p>A complete image of the final system can be seen here:</p>
<table>
<thead>
<tr>
<th style=text-align:center>Front</th>
<th style=text-align:center>Back</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center><img src=../images/system_front.jpg alt=system_image_front></td>
<td style=text-align:center><img src=../images/system_back.jpg alt=system_image_back></td>
</tr>
</tbody>
</table>
<p><a id=tank></a></p>
<h2 id=tank-hahahugoshortcode-s0-hbhb>Tank <a class=to-the-top href=#Navigation style=text-decoration:none>
<span class=nav-arrow aria-hidden=true>&uarr;</span>
</a></h2>
<p>Our tank is comprised of two sheets of 10" by 12" glass with thickness 3/32" separated by a 1/4" acrylic rim. They are attached with epoxy.</p>
<p>Next, the tank was cleaned extremely thoroughly using ammonia and hot water and scrubbed with Goof Off. Without this cleaning process, the ferrofluid would stain the glass severly, leaving the glass a brown-tinted mess.</p>
<p><img src=../images/cool_tank.gif alt=cool_tank></p>
<p><a id=magnets></a></p>
<h2 id=magnets-hahahugoshortcode-s1-hbhb>Magnets <a class=to-the-top href=#Navigation style=text-decoration:none>
<span class=nav-arrow aria-hidden=true>&uarr;</span>
</a></h2>
<p>The first plan for team FerroFish was to use PCB magnets. However, upon testing the PCB magnets, we found that they were not viable for lifting and moving ferrofluid, so the decision was made to create our own electromagnets.</p>
<p>Electromagnets are created by wrapping wire around a ferrous core and applying a voltage to the wire, creating a current in the wire. The current induces a magnetic field and thus magnetizes the ferrous core — creating a magnet.</p>
<p>The equation for the strength of the field given by our electromagnets is below:</p>
<p>$$B = \frac{\mu_oNI}{l}$$</p>
<p>Where $\mu_o$ is the permittivity of free space, $N$ is the number of turns in the wire, $I$ is the current, and $l$ is the length of the solenoid.</p>
<p>Electromagnets are more flexible than permanent magnets because they can be easily turned on and off by adjusting voltage. As a team, we decided that electromagnets would provide the flexibility we needed.</p>
<h5 id=creating-our-electromagnets>Creating our Electromagnets</h5>
<p>We decided for cost purposes that we would create our own electromagnets rather than buying premade ones. We calculated that 1000 turns would create a magnetic field strong enough to lift the ferrofluid with reasonable current.</p>
<p>Creating our electromagnets was three main steps:</p>
<ol>
<li>3D print spools for winding</li>
<li>Create the magnets by winding the wire</li>
<li>Soldering jumper cables onto the magnets so they can be used with controller boards</li>
</ol>
<h5 id=3d-printing-spools>3D Printing Spools</h5>
<p>The spools were printed in two parts and then glued together. These spools were then mounted onto the wiring rig, so wire could be wound onto them.</p>
<p><img src=../images/spool_cad.png alt=spool_cad></p>
<h5 id=winding-the-wires>Winding the Wires</h5>
<p>On the rig for winding the magnets, there is a counter that let the winder know when 1000 turns had been reached. Our goal for the magnet grid was a 4x4 grid, or 16 total magnets. Extra spools were printed in the event we had magnets break.</p>
<h5 id=soldering-the-magnets>Soldering the Magnets</h5>
<p>Once the magnets were wound, jumper cables were soldered onto the ends of the wires. The connection between the wire and the jumper cable was then wrapped in a heat shrink wrap to prevent shorts with other wires. A finished magnet is pictured below.</p>
<p><img src=../images/magnet.jpg alt=magnet></p>
<h5 id=using-the-magnets>Using the Magnets</h5>
<p>We 3D printed a holder for our 4x4 magnet grid. This holder went through multiple iterations as we refined our tolerances and also created a way to hold the magnets to the tank. An image of all 16 magnets as well as the CAD for the final holder is below.</p>
<p><img src=../images/magnet_holder_iso.png alt=magnet_holder_iso></p>
<p><img src=../images/magnet_holder_iso_lower.png alt=magnet_holder_iso_lower></p>
<p><img src=../images/irl_magnet_holder.png alt=irl_magnet_holder></p>
<h5 id=final-take-aways>Final Take-Aways</h5>
<p>While originally we did not think that creating our own electromagnets would be cost or time effective, by the end of our project, it was apparent that it was our best option.</p>
<p>Creating the magnets required a lot of patience and communication, but ultimately, it created a better end product as we were able to successfully make a magnet grid with them and lift the ferrofluid.</p>
<p><a id=controller></a></p>
<h2 id=magnet-controller-and-electronics-hahahugoshortcode-s2-hbhb>Magnet Controller and Electronics <a class=to-the-top href=#Navigation style=text-decoration:none>
<span class=nav-arrow aria-hidden=true>&uarr;</span>
</a></h2>
<p>Our magnet controller is based off of the <a href=https://hackaday.io/project/167056-fetch-a-ferrofluid-display/log/197057-fetch-v2-massive-hardware-upgrade>Applied Procrastination Electromagnet Control Board</a> schematic. The main idea is to control an LED driver via I2C from your microcontroller to turn electromagnets on or off. The current out of the driver is not large enough to power the electromagnets, however, so we placed the signal through a Darlington transistor array. We included two sets of header pins for our input signals and power rails, so we could chain together multiple boards, if we chose to expand the display.</p>
<p>The controller has 16 output pins, which connect to the 4 by 4 magnet array. It receives I2C messages from the Arduino Mega, which can be programmed via Serial or with an SD card with animations preloaded (click to enlarge schematics).</p>
<p><a href=../images/controller_kicad.png><img src=../images/controller_kicad.png alt=controller_kicad></a></p>
<p>Pullup resistors for I2C were selected based on <a href=https://learn.adafruit.com/assets/36269>Adafruit schematics</a> for our LED driver. The capacitor values were chosen with help from Course Assistants Lauren and Corey as well as the Adafruit schematic.</p>
<p>The Arduino Mega was used due to an unfortunate frying of our Teensy 4.1 (may it rest in peace). The Arduino Mega has more memory than an Uno but has less memory and is slower than the Teensy.</p>
<p><a href=../images/block_diagram.jpg><img src=../images/block_diagram.jpg alt=block_diagram></a></p>
<p><a id=firmware></a></p>
<h2 id=firmware-hahahugoshortcode-s3-hbhb>Firmware <a class=to-the-top href=#Navigation style=text-decoration:none>
<span class=nav-arrow aria-hidden=true>&uarr;</span>
</a></h2>
<p>As shown in our <a href=#system>system diagram</a>, a microcontroller plays back animations by sending commands over I2C to the PCA9685 PWM driver. This gives the firmware a few responsibilities:</p>
<ol>
<li>Read animations from the animation generator in an agreed-upon format from the SD card or serial, or read other debug commands from serial.</li>
<li>Interpolate to create smooth fades between frames and space apart animation frames over time.</li>
<li>Send commands to the PCA9685 over PWM.</li>
</ol>
<p>To do this we have a simple state machine with states of &ldquo;off&rdquo;, &ldquo;manual&rdquo;, &ldquo;SD&rdquo;, and &ldquo;serial&rdquo;. The &ldquo;off&rdquo; state turns off all magnets and immediately transitions to &ldquo;manual&rdquo;; &ldquo;manual&rdquo; stays in manual and waits for commands over serial; &ldquo;SD&rdquo; reads animation frames from the SD card until it reaches the end of the file and then transitions to off; &ldquo;serial&rdquo; reads animation frames from serial until the serial buffer is empty for long enough for reads to time out. This state machine design means our code is fully interruptable by user commands, and it makes it very easy to add new commands and states, which was important during prototyping because we decided to add serial streaming when we had SD card problems and to better support our presentation at EXPO.</p>
<p>The &ldquo;serial&rdquo; and &ldquo;SD&rdquo; states use the same parsing code; because both the SD file object (<code>FsFile</code>) and the Arduino <code>Serial</code> object inherit from the Arduino <code>Stream</code> object, we can use the same code for parsing files and for parsing serial streams, as the formats are designed to be the same. We used a text-based format for instead of a binary format to avoid endianness and struct packing issues and to make our parsing code easy to modify and read by everyone on the team.</p>
<p>The firmware was written in C++17 and tries to do things in a C++ style where possible. This mostly means using <code>constexpr</code> instead of preprocessor macros for constants, <code>if constexpr</code> instead of preprocessor conditionals, <code>std::array</code> instead of C-style arrays, and C++-style includes of C standard library headers. We also define our own classes for managing the hardware. Their interfaces are equivalent so we can switch between different PWM drivers (e.g. between a simple PWM driver and an interpolating PWM driver). This was useful for initial debugging before we had brought up all the hardware, which helped a lot with integration.</p>
<p>We&rsquo;ve used both an Arduino Uno and Mega and Teensy 4.1 and we ultimately needed to support all three because we prototyped with the Uno and initially used the Teensy until our perfboard failed and shorted the Teensy. This led us to switch to the Arduino Mega, which has a little bit more memory than the Uno (which we needed). The GCC toolchain for the Teensy includes all of the C++ standard template library, but the Arduino toolchian (<code>avr-gcc</code>) doesn&rsquo;t, so we also include the <code>avr_stl</code> library and conditionally include it if we&rsquo;re on an AVR-based board.</p>
<p>The portability of the code across microcontrollers was a very important part of having a smooth integration process for us because it enabled early prototyping without setting up the Teensy, and it allowed for a plan B when we had damaged our hardware.</p>
<p>We don&rsquo;t use the Adafruit servo driver hardware (we have custom-designed PCBs), but we use the library that comes with it because it&rsquo;s a complete and easy-to-use implementation of all the PCA9685&rsquo;s I2C commands. We also use Bill Greiman&rsquo;s SdFat library for reading from the SD card. We chose this over the Arduino-default one because it supports SDIO if the hardware has that capability (the Teensy 4.1 can do SD over SDIO instead of just SPI.)</p>
<p><a id=animation></a></p>
<h2 id=animation-generator>Animation Generator</h2>
<p>The user needs to be able to easily draw animations. The microcontroller needs to have animations in a format it can read easily. This gives the animation software some responsibilities:</p>
<ol>
<li>Output the animations in a variety of formats: to a preview window, to a file, or output via serial. The animation file and serial formats need to agree between the microcontroller and the animation software, which means the people writing that software needed to plan this out</li>
<li>Be able to switch between these output formats easily.</li>
<li>We also anticipated having multiple ways to generate animations: programatically, from external drawing programs, or from splines. At the end of the day we only generated them from drawing programs, but this was an initial requirement that worked its way into our design.</li>
</ol>
<p>To execute on this design we made the animation generator have a design with switchable &ldquo;backends&rdquo; and &ldquo;frontends&rdquo;:
<a href=../images/frontend_backend.jpg><img src=../images/frontend_backend.jpg alt="Backend and frontend design"></a>
(Click to enlarge)</p>
<p>We only ended up implemented the file-reading frontend, but we did have multiple backends that allowed us to view animations on the computer, stream over serial, and export to a file that could be loaded onto our SD card. We used the same format for streaming over serial and for writing to an output file, which allowed us to share a lot of code. The file format was, as mentioned above, a simple text-based format that we chose to avoid endianness and struct packing issues that can come with binary formants (unless you&rsquo;re careful about their implementation.) This isn&rsquo;t the most space-efficient format, but it&rsquo;s very easy to inspect and the code is easy for others to read. The easy inspection of the file output and the visual preview backend made it easy to insure this code was correct long before we had our microcontroller firmware working, which made final integration much smoother. Because of this modular system it was very easy to add file export and serial capabilities when we needed them, which was made integration go more smoothly.</p>
<p>We used OpenCV to read and display images. The rest of our code just used C++17 standard library features and the CMake build system.</p>
<p><a id=budget></a></p>
<h2 id=budget-hahahugoshortcode-s4-hbhb>Budget <a class=to-the-top href=#Navigation style=text-decoration:none>
<span class=nav-arrow aria-hidden=true>&uarr;</span>
</a></h2>
<p>Our total cost for our final display was <strong>$231.13</strong>. Below shows the breakdown by subsystem and item:</p>
<table>
<thead>
<tr>
<th>Tank</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>Glass panes</td>
<td>$6.30</td>
</tr>
<tr>
<td>Acrylic spacer</td>
<td>$4*</td>
</tr>
<tr>
<td>Delrin holders</td>
<td>$2*</td>
</tr>
<tr>
<td>Epoxy</td>
<td>$10.94</td>
</tr>
<tr>
<td>Ferrofluid</td>
<td>$31</td>
</tr>
<tr>
<td>Ammonia</td>
<td>$1.78</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>$56.12</strong></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Magnets and Structures</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>3D-printed pieces (&lt; 200 g)</td>
<td>$5*</td>
</tr>
<tr>
<td>Threaded inserts</td>
<td>$6.93</td>
</tr>
<tr>
<td>M3 screws</td>
<td>$5.33</td>
</tr>
<tr>
<td>Steel dowels</td>
<td>$20.76</td>
</tr>
<tr>
<td>Magnet wire</td>
<td>$10*</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>$48.02</strong></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Electronics (Mouser Part Number)</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dupont socket/socket connectors (485-266)</td>
<td>$11.85</td>
</tr>
<tr>
<td>Pin headers (649-1012937891601BLF)</td>
<td>$3.99</td>
</tr>
<tr>
<td>Darlington transistor arrays (511-ULQ2801A)</td>
<td>$16.25</td>
</tr>
<tr>
<td>LED Drivers (771-PCA9685BS118)</td>
<td>$24.96</td>
</tr>
<tr>
<td>0.1 uF Capacitors (963-HMF212B7104KGHT)</td>
<td>$2.80</td>
</tr>
<tr>
<td>10 uF Polar Capacitors (710-865080340001)</td>
<td>$2.52</td>
</tr>
<tr>
<td>10k resistors (652-CR0603FX-1002ELF)</td>
<td>$0.75</td>
</tr>
<tr>
<td><strong>Total</strong> (including tax/shipping)</td>
<td><strong>$75.06</strong></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Boards</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>Arduino Mega*</td>
<td>$34.93</td>
</tr>
<tr>
<td>Custom controller boards</td>
<td>$15</td>
</tr>
<tr>
<td>Perfboard</td>
<td>$2*</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>$51.93</strong></td>
</tr>
</tbody>
</table>
<p>* Estimate (Obtained for Free)</p>
</div>
</div>
<div class="section-inner d-none">
<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">
<ul class=post-meta>
<li class="post-tags meta-wrapper">
<span class=meta-icon>
<span class=screen-reader-text>Tags</span><svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M15.4496399 8.42490555 8.66109799 1.63636364H1.63636364V8.66081885L8.42522727 15.44178c.153464939999999.1536358.36171062.2399618.57886364.2399618S9.42948961 15.5954158 9.58327627 15.4414581L15.4486339 9.57610048C15.7651495 9.25692435 15.7649133 8.74206554 15.4496399 8.42490555zm1.1588024 2.30554895L10.7406818 16.59822C10.280287 17.0591273 9.65554997 17.3181054 9.00409091 17.3181054 8.35263185 17.3181054 7.72789481 17.0591273 7.26815877 16.5988788L.239976954 9.57887876C.0863319284 9.4254126.0 9.21716044.0 9V.818181818C0 .366312477.366312477.0.818181818.0H9c.21699531.0.42510306.0862010512.57854191.239639906L16.6084423 7.26954545c.9516852.95736467.9516852 2.50354443.0 3.46090905zM5 6c-.55228475.0-1-.44771525-1-1s.44771525-1 1-1 1 .44771525 1 1-.44771525 1-1 1z"/></svg> </span>
<span class=meta-text> </span>
</li>
</ul>
</div>
</div>
</article>
</main>
<div class="footer-nav-widgets-wrapper header-footer-group">
<div class="footer-inner section-inner">
<div class="footer-top has-social-menu">
<nav aria-label="Social links" class=footer-social-wrapper>
<ul class="social-menu reset-list-style social-icons fill-children-current-color">
</ul>
</nav>
</div>
</div>
</div>
<footer id=site-footer role=contentinfo class=header-footer-group>
<div class=section-inner>
<div class=footer-credits>
<p class=footer-copyright>Copyright © 2021. Licensed under the GNU GPL, version 3 or later.</p>
</div>
<a class=to-the-top href=#site-header>
<span class=to-the-top-long>
To the top <span class=arrow aria-hidden=true>&uarr;</span> </span>
<span class=to-the-top-short>
Up <span class=arrow aria-hidden=true>&uarr;</span> </span>
</a>
</div>
</footer>
<script>var indexURL="https://pietroglyph.github.io/ferrofluid-display/index.json"</script>
<script src=https://pietroglyph.github.io/ferrofluid-display/js/jquery.min.min.js></script>
<script src=https://pietroglyph.github.io/ferrofluid-display/js/script.min.js></script>
<script src=https://pietroglyph.github.io/ferrofluid-display/js/search.min.js></script>
<script src=https://pietroglyph.github.io/ferrofluid-display/plugins/search.js></script>
</body>
</html>